<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Messaging</title>
  <meta name="description" content="Distributed, masterless, high performance, fault tolerant data processing
">

  <script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-72807409-1', 'auto');
	  ga('send', 'pageview');
  </script>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/lavish-bootstrap.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/cheat-sheet-style.css">
  <link rel="canonical" href="http://www.onyxplatform.org/docs/user-guide/latest/messaging.html">
  <link rel="alternate" type="application/rss+xml" title="Onyx" href="http://www.onyxplatform.org/feed.xml" />
</head>



  <body>
    <header class="site-header">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-2"></div>
      <div class="col-md-1">
        <h2><a id="nav-title" href="/">Onyx</a></h2>
      </div>
      <div class="col-md-1"></div>
      <div class="col-md-6">
        <ul class="nav nav-pills navbar-right">
          <li class="nav-choice" role="presentation"><a href="/learn">learn</a></li>
          <li class="nav-choice" role="presentation"><a href="/docs">docs</a></li>
          <li class="nav-choice" role="presentation"><a href="/tools">tools</a></li>
          <li class="nav-choice" role="presentation"><a href="/blog">blog</a></li>
          <li class="nav-choice" role="presentation"><a href="https://github.com/onyx-platform/onyx">github</a></li>
          <li class="nav-choice" role="presentation"><a href="/support">support</a></li>
          <li class="nav-choice" role="presentation"><a href="/team">team</a></li>
        </ul>
      </div>
      <div class="col-md-2"></div>
    </div>
  </div>
</header>

    <div class="container-fluid">
  <div class="row">
    <div class="col-md-2 panel page-contents">
      <h4>Contents</h4>
      <ul>
  <li><a href="/docs/cheat-sheet/latest">cheat sheet</a></li>
  <li><a href="/docs/api/0.9.1">api docs</a></li>
  <li>user guide</li>
  <ul>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/aggregation-state-management.html">Aggregation and State</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/apis.html">APIs</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/architecture-low-level-design.html">Architecture</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/backpressure.html">Backpressure</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/concepts.html">Concepts</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/core-async-plugin.html">core.async Plugin</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/deployment.html">Deployment</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/environment.html">Environment</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/examples.html">Examples</a></li>
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/faq.html">FAQ</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/flow-conditions.html">Flow Conditions</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/functions.html">Functions</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/information-model.html">Information Model</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/lifecycles.html">Lifecycles</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/logging.html">Logging</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/messaging.html">Messaging</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/monitoring.html">Monitoring</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/peer-config.html">Peer Configuration</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/performance-tuning.html">Performance Tuning</a></li>
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/plugins.html">Plugins</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/production-check-list.html">Production Checklist</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/scheduling.html">Scheduling</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/subscription.html">Subscription</a></li>
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/testing-onyx-jobs.html">Testing Onyx Jobs</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/triggers.html">Triggers</a></li>
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/what-does-it-offer.html">What does it Offer?</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/latest/windowing.html">Windowing</a></li>
    
    
  </ul>
</ul>

    </div>
    <div class="col-md-1"></div>
    <div class="col-md-7 panel">
      <h2 id="messaging">Messaging</h2>

<h3 id="background">Background</h3>

<p>The messaging layer takes care of the direct peer to peer transfer of segment<br />
batches, acks, segment completion and segment retries to the relevant virtual<br />
peers.</p>

<h3 id="messaging-implementations">Messaging Implementations</h3>

<p>The Onyx messaging implementation is pluggable and alternative implementations<br />
can be selected via the <code>:onyx.messaging/impl</code> <a href="/docs/user-guide/latest/peer-config.html">peer-config</a>.</p>

<h4 id="aeron-messaging">Aeron Messaging</h4>

<p>Owing to <a href="https://github.com/real-logic/Aeron">Aeronâ€™s</a> high throughput and low<br />
latency, Aeron is the default Onyx messaging implementation. There are a few<br />
relevant considerations when using the Aeron implementation.</p>

<h5 id="subscription-connection-multiplexing">Subscription (Connection) Multiplexing</h5>

<p>One issue when scaling Onyx to a many node cluster is that every virtual peer<br />
may require a communications channel to any other virtual peer. As a result, a<br />
naive implementation will require up to m<sup>2</sup> connections over the<br />
cluster, where m is the number of virtual peers. By sharing Aeron subscribers<br />
between virtual peers on a node, this can be reduced to n<sup>2</sup><br />
connections, where n is the number of nodes. This reduces the amount of<br />
overhead required to maintain connections between peers, allowing the<br />
cluster to scale better as the number of nodes to increase.</p>

<p>It is worth noting that Aeron subscribers (receivers) must also generally<br />
perform deserialization.  Therefore, subscribers may become CPU bound by the<br />
amount of deserializaton work that needs to be performed. In order to reduce<br />
this effect, multiple subscribers can be instantiated per node.  This can be<br />
tuned via <code>:onyx.messaging.aeron/subscriber-count</code> in<br />
<a href="/docs/user-guide/latest/peer-config.html">peer-config</a>. As increasing<br />
the number of subscribers may lead back to an undesirable growth in the number<br />
of connections between nodes, each node will only choose one subscription to<br />
communicate through. The choice of subscriber is calculated via a hash of the combined IPs of the<br />
communicating nodes, in order to consistently spread the use of subscribers over the cluster.</p>

<p>Clusters which perform a large proportion of the time serializing should<br />
consider increasing the subscriber count. As a general guide, <code># cores = #
virtual peers + # subscribers</code>.</p>

<h5 id="connection-short-circuiting">Connection Short Circuiting</h5>

<p>When virtual peers are co-located on the same node, messaging will bypass the<br />
use of Aeron and directly communicate the message without any use of the<br />
network and without any serialization. Therefore, performance benchmarks<br />
performed on a single node can be very misleading.</p>

<p>The <a href="/docs/user-guide/latest/peer-config.html">peer-config</a> option, <code>:onyx.messaging/allow-short-circuit?</code><br />
is provided for the purposes of more realistic performance testing on a single node.</p>

<h5 id="port-use">Port Use</h5>

<p>The Aeron messaging implementation will use the port configured via<br />
<code>:onyx.messaging/peer-port</code>. This <em>UDP port</em> must be unfirewalled.</p>

<h5 id="media-driver">Media Driver</h5>

<p>Aeron requires a media driver to be used on each node. Onyx provides an<br />
embedded media driver for local testing, however use of the embedded driver is<br />
not recommended in production. The embedded driver can be configured via the<br />
<code>:onyx.messaging.aeron/embedded-driver?</code> <a href="/docs/user-guide/latest/peer-config.html">peer-config</a> option.</p>

<p>When using Aeron messaging in production, a media driver should be created in<br />
another java process. You can do this via the following code snippet, or by using the <a href="https://github.com/real-logic/Aeron#media-driver-packaging">Aeron distribution</a>.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>(<span style="color:#080;font-weight:bold">ns</span> <span style="color:#707;font-weight:bold">your-app.aeron-media-driver</span>
  (<span style="color:#A60">:require</span> [clojure.core.async <span style="color:#A60">:refer</span> [chan &lt;!!]])
  (<span style="color:#A60">:import</span> [uk.co.real_logic.aeron Aeron$Context]
           [uk.co.real_logic.aeron.driver MediaDriver MediaDriver$Context ThreadingMode]))

(<span style="color:#080;font-weight:bold">defn</span> <span style="color:#06B;font-weight:bold">-main</span> [&amp; args]
  (<span style="color:#080;font-weight:bold">let</span> [ctx (<span style="color:#080;font-weight:bold">doto</span> (MediaDriver$Context.))
        media-driver (MediaDriver/launch ctx)]
    (<span style="color:#080;font-weight:bold">println</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Launched the Media Driver. Blocking forever...</span><span style="color:#710">&quot;</span></span>)
    (&lt;!! (chan))))
</pre></div>
</div>
</div>

<h5 id="configuration-options">Configuration Options</h5>

<p>Aeron is independently configurable via Java properties (e.g.  <code>JAVA_OPTS="-Daeron.mtu.length=16384"</code>).<br />
Configuration of these may cause different performance characteristics, and<br />
certain options may need to be configured in order to communicate large segments between peers.</p>

<p>Documentation for these configuration options can be found in<br />
<a href="https://github.com/real-logic/Aeron/wiki/Configuration-Options">Aeronâ€™s documentation</a>.</p>

    </div>
  </div>
</div>


    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <small><center>Copyright Â© Distributed Masonry 2016</center></small>
    </div>

  </div>

</footer>

  </body>

</html>
