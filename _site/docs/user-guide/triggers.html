<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Triggers</title>
  <meta name="description" content="Distributed, masterless, high performance, fault tolerant data processing
">

  <script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-72807409-1', 'auto');
	  ga('send', 'pageview');
  </script>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/lavish-bootstrap.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/cheat-sheet-style.css">
  <link rel="canonical" href="http://www.onyxplatform.org/docs/user-guide/triggers.html">
  <link rel="alternate" type="application/rss+xml" title="Onyx" href="http://www.onyxplatform.org/feed.xml" />
</head>



  <body>
    <header class="site-header">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-2"></div>
      <div class="col-md-1">
        <h2><a id="nav-title" href="/">Onyx</a></h2>
      </div>
      <div class="col-md-1"></div>
      <div class="col-md-6">
        <ul class="nav nav-pills navbar-right">
          <li class="nav-choice" role="presentation"><a href="/learn">learn</a></li>
          <li class="nav-choice" role="presentation"><a href="/docs">docs</a></li>
          <li class="nav-choice" role="presentation"><a href="/tools">tools</a></li>
          <li class="nav-choice" role="presentation"><a href="/blog">blog</a></li>
          <li class="nav-choice" role="presentation"><a href="https://github.com/onyx-platform/onyx">github</a></li>
          <li class="nav-choice" role="presentation"><a href="/support">support</a></li>
          <li class="nav-choice" role="presentation"><a href="/team">team</a></li>
        </ul>
      </div>
      <div class="col-md-2"></div>
    </div>
  </div>
</header>

    <div class="container-fluid">
  <div class="row">
    <div class="col-md-2 panel page-contents">
      <h4>Contents</h4>
      <ul>
  <li><a href="/docs/cheat-sheet">cheat sheet</a></li>
  <li><a href="/docs/api">api docs</a></li>
  <li>user guide</li>
  <ul>
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/aggregation-state-management.html">Aggregation and State</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/apis.html">APIs</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/architecture-low-level-design.html">Architecture</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/backpressure.html">Backpressure</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/concepts.html">Concepts</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/core-async-plugin.html">core.async Plugin</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/deployment.html">Deployment</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/environment.html">Environment</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/examples.html">Examples</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/faq.html">FAQ</a></li>
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/flow-conditions.html">Flow Conditions</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/functions.html">Functions</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/information-model.html">Information Model</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/lifecycles.html">Lifecycles</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/logging.html">Logging</a></li>
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/messaging.html">Messaging</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/monitoring.html">Monitoring</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/peer-config.html">Peer Configuration</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/performance-tuning.html">Performance Tuning</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/plugins.html">Plugins</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/production-check-list.html">Production Checklist</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/scheduling.html">Scheduling</a></li>
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/subscription.html">Subscription</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/testing-onyx-jobs.html">Testing Onyx Jobs</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/triggers.html">Triggers</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/what-does-it-offer.html">What does it Offer?</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/windowing.html">Windowing</a></li>
    
    
  </ul>
</ul>

    </div>
    <div class="col-md-1"></div>
    <div class="col-md-7 panel">
      <h2 id="triggers">Triggers</h2>

<p>In this section, we talk about Triggers. Triggers are a feature that interact with <em>Windows</em>. Windows capture and bucket data over time. Triggers let you release the captured data over a variety stimuli.</p>

<h3 id="summary">Summary</h3>

<p>Windows capture data over time and place segments into discrete, possibly overlapping buckets. By itself, this is a relatively useless concept. In order to harness the information that has been captured and rolled up, we need to <em>move</em> it somewhere. Triggers let us interact with the state in each extent of a window.</p>

<p>Example project: <a href="https://github.com/onyx-platform/onyx-examples/tree/0.8.x/aggregation">aggregation</a></p>

<h3 id="trigger-types">Trigger Types</h3>

<p>Onyx ships a number of trigger implementations that can be used out of the box. Each trigger fires in response to a particular stimulous. All triggers implemented in Onyx core fire at task completion. We outline each here and show an example of each in action.</p>

<h4 id=":timer"><code>:timer</code></h4>

<p>This trigger sleeps for a duration of <code>:trigger/period</code>. When it is done sleeping, the <code>:trigger/sync</code> function is invoked with its usual arguments. The trigger goes back to sleep and repeats itself.</p>
<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">{</span><span class="ss">:trigger/window-id</span> <span class="ss">:collect-segments</span>
 <span class="ss">:trigger/refinement</span> <span class="ss">:discarding</span>
 <span class="ss">:trigger/on</span> <span class="ss">:timer</span>
 <span class="ss">:trigger/period</span> <span class="p">[</span><span class="mi">3</span> <span class="ss">:seconds</span><span class="p">]</span>
 <span class="ss">:trigger/sync</span> <span class="ss">::write-to-dynamo</span>
 <span class="ss">:trigger/doc</span> <span class="s">&quot;Writes state to DynamoDB every 5 seconds, discarding intermediate state&quot;</span><span class="p">}</span>
</code></pre></div>
<h4 id=":segment"><code>:segment</code></h4>

<p>Trigger wakes up in reaction to a new segment being processed. Trigger only fires once every <code>:trigger/threshold</code> segments. When the threshold is exceeded, the count of new segments goes back to <code>0</code>, and the looping proceeds again in the same manner.</p>
<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">{</span><span class="ss">:trigger/window-id</span> <span class="ss">:collect-segments</span>
 <span class="ss">:trigger/refinement</span> <span class="ss">:accumulating</span>
 <span class="ss">:trigger/on</span> <span class="ss">:segment</span>
 <span class="ss">:trigger/fire-all-extents?</span> <span class="nv">true</span>
 <span class="ss">:trigger/threshold</span> <span class="p">[</span><span class="mi">5</span> <span class="ss">:elements</span><span class="p">]</span>
 <span class="ss">:trigger/sync</span> <span class="ss">::write-to-stdout</span>
 <span class="ss">:trigger/doc</span> <span class="s">&quot;Writes the window contents to stdout every 5 segments&quot;</span><span class="p">}</span>
</code></pre></div>
<h4 id=":punctuation"><code>:punctuation</code></h4>

<p>Trigger wakes up in reaction to a new segment being processed. Trigger only fires if <code>:trigger/pred</code> evaluates to <code>true</code>. The signature of <code>:trigger/pred</code> is of arity-5: <code>event, window-id, lower, upper, segment</code>. Punctuation triggers are often useful to send signals through that indicate that no more data will be coming through for a particular window of time.</p>
<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">{</span><span class="ss">:trigger/window-id</span> <span class="ss">:collect-segments</span>
 <span class="ss">:trigger/refinement</span> <span class="ss">:discarding</span>
 <span class="ss">:trigger/on</span> <span class="ss">:punctuation</span>
 <span class="ss">:trigger/pred</span> <span class="ss">::trigger-pred</span>
 <span class="ss">:trigger/sync</span> <span class="ss">::write-to-stdout</span>
 <span class="ss">:trigger/doc</span> <span class="s">&quot;Writes the window contents to std out :trigger/pred is true for this segment&quot;</span><span class="p">}</span>
</code></pre></div>
<h4 id=":watermark"><code>:watermark</code></h4>

<p>Trigger wakes up in reaction to a new segment being processed. Trigger only fires if the value of <code>:window/window-key</code> in the segment exceeds the upper-bound in the extent of an active window. This is a shortcut function for a punctuation trigger that fires when any piece of data has a time-based window key that above another extent, effectively declaring that no more data for earlier windows will be arriving.</p>
<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">{</span><span class="ss">:trigger/window-id</span> <span class="ss">:collect-segments</span>
 <span class="ss">:trigger/refinement</span> <span class="ss">:discarding</span>
 <span class="ss">:trigger/on</span> <span class="ss">:watermark</span>
 <span class="ss">:trigger/sync</span> <span class="ss">::write-to-stdout</span>
 <span class="ss">:trigger/doc</span> <span class="s">&quot;Writes the window contents to stdout when this window&#39;s watermark has been exceeded&quot;</span><span class="p">}</span>
</code></pre></div>
<h4 id=":percentile-watermark"><code>:percentile-watermark</code></h4>

<p>Trigger wakes up in reaction to a new segment being processed. Trigger only fires if the value of <code>:window/window-key</code> in the segment exceeds the lower-bound plus the percentage of the range as indicated by <code>:trigger/watermark-percentage</code>, a <code>double</code> greater than <code>0</code> and less than <code>1</code>. This is an alternative to <code>:watermark</code> that allows you to trigger on <em>most</em> of the data arriving, not necessarily every last bit.</p>
<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">{</span><span class="ss">:trigger/window-id</span> <span class="ss">:collect-segments</span>
 <span class="ss">:trigger/refinement</span> <span class="ss">:discarding</span>
 <span class="ss">:trigger/on</span> <span class="ss">:percentile-watermark</span>
 <span class="ss">:trigger/watermark-percentage</span> <span class="mf">0.95</span>
 <span class="ss">:trigger/sync</span> <span class="ss">::write-to-stdout</span>
 <span class="ss">:trigger/doc</span> <span class="s">&quot;Writes the window contents to stdout when this window&#39;s watermark is exceeded by 95% of its range&quot;</span><span class="p">}</span>
</code></pre></div>
<h3 id="refinement-modes">Refinement Modes</h3>

<p>A refinement mode allows you to articulate what should happen to the state of a window extent after a trigger has been invoked.</p>

<h4 id=":accumulating"><code>:accumulating</code></h4>

<p>Setting <code>:trigger/refinement</code> to <code>:accumulating</code> means that the state of a window extent is maintained exactly as is after the trigger invocation. This is useful if you want to an answer to a query to &quot;become more correct over time&quot;.</p>

<h4 id=":discarding"><code>:discarding</code></h4>

<p>Setting <code>:trigger/refinement</code> to <code>:discarding</code> means that the state of a window extent is set back to the value it was initialized with after the trigger invocation. You&#39;d want to use this if the results from one periodic update bear no connection to subsequent updates.</p>

<h3 id="syncing">Syncing</h3>

<p>Onyx offers you the ultimate flexibility on what to do with your state during a trigger invocation. Set <code>:trigger/sync</code> to a fully qualified, namespaced function on the classpath that takes five arguments: the event map, the window map that this trigger is defined on, the trigger map, a map with keys (<code>:window-id</code>, <code>:lower-bound</code>, <code>:upper-bound</code>), and the window state as an immutable value. The bounds are useful for determining what this window ID represents. For example, if <code>:window/range</code> is specified in <code>:seconds</code>, <code>:minutes</code>, or some other unit of time, both the upper and lower bounds will be returned in <code>:milliseconds</code>. The return value of this function is ignored. You can use lifecycles to supply any stateful connections necessary to sync your data. Supplied values from lifecycles will be available through the first parameter - the event map.</p>

<h3 id="trigger-specification">Trigger Specification</h3>

<p>See the Information Model chapter for an exact specification of what values the Trigger maps need to supply. Here we will describe what each of the keys mean.</p>

<table><thead>
<tr>
<th>key name</th>
<th>description</th>
</tr>
</thead><tbody>
<tr>
<td><code>:trigger/window-id</code></td>
<td>A <code>:window/id</code> specified in the collection of windows</td>
</tr>
<tr>
<td><code>:trigger/refinement</code></td>
<td>A mode of refinement, one of <code>:accumlating</code>, <code>:discarding</code></td>
</tr>
<tr>
<td><code>:trigger/on</code></td>
<td>The stimulus to fire the trigger as a reaction.</td>
</tr>
<tr>
<td><code>:trigger/sync</code></td>
<td>Fully qualified namespaced keyword of a function to call with the state</td>
</tr>
<tr>
<td><code>:trigger/fire-all-extents?</code></td>
<td>When true, fires every extent of a window in response to a trigger.</td>
</tr>
<tr>
<td><code>:trigger/doc</code></td>
<td>An optional docstring explaining the trigger&#39;s purpose</td>
</tr>
</tbody></table>

    </div>
  </div>
</div>


    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <small><center>Copyright © Distributed Masonry 2016</center></small>
    </div>

  </div>

</footer>

  </body>

</html>
