<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Environment</title>
  <meta name="description" content="Distributed, masterless, high performance, fault tolerant data processing
">

  <script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-72807409-1', 'auto');
	  ga('send', 'pageview');
  </script>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/lavish-bootstrap.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/cheat-sheet-style.css">
  <link rel="canonical" href="http://www.onyxplatform.org/docs/user-guide/0.8.8/environment.html">
  <link rel="alternate" type="application/rss+xml" title="Onyx" href="http://www.onyxplatform.org/feed.xml" />
</head>



  <body>
    <header class="site-header">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-2"></div>
      <div class="col-md-1">
        <h2><a id="nav-title" href="/">Onyx</a></h2>
      </div>
      <div class="col-md-1"></div>
      <div class="col-md-6">
        <ul class="nav nav-pills navbar-right">
          <li class="nav-choice" role="presentation"><a href="/learn">learn</a></li>
          <li class="nav-choice" role="presentation"><a href="/docs">docs</a></li>
          <li class="nav-choice" role="presentation"><a href="/tools">tools</a></li>
          <li class="nav-choice" role="presentation"><a href="/blog">blog</a></li>
          <li class="nav-choice" role="presentation"><a href="https://github.com/onyx-platform/onyx">github</a></li>
          <li class="nav-choice" role="presentation"><a href="/support">support</a></li>
          <li class="nav-choice" role="presentation"><a href="/team">team</a></li>
        </ul>
      </div>
      <div class="col-md-2"></div>
    </div>
  </div>
</header>

    <div class="container-fluid">
  <div class="row">
    <div class="col-md-2 panel page-contents">
      <h4>Contents</h4>
      <ul>
  <li><a href="/docs/cheat-sheet/0.8.8">cheat sheet</a></li>
  <li><a href="/docs/api/0.8.8">api docs</a></li>
  <li>user guide</li>
  <ul>
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/aggregation-state-management.html">Aggregation and State</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/apis.html">APIs</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/architecture-low-level-design.html">Architecture</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/backpressure.html">Backpressure</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/concepts.html">Concepts</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/core-async-plugin.html">core.async Plugin</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/deployment.html">Deployment</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/environment.html">Environment</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/examples.html">Examples</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/faq.html">FAQ</a></li>
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/flow-conditions.html">Flow Conditions</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/functions.html">Functions</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/information-model.html">Information Model</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/lifecycles.html">Lifecycles</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/logging.html">Logging</a></li>
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/messaging.html">Messaging</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/monitoring.html">Monitoring</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/peer-config.html">Peer Configuration</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/performance-tuning.html">Performance Tuning</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/plugins.html">Plugins</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/production-check-list.html">Production Checklist</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/scheduling.html">Scheduling</a></li>
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/subscription.html">Subscription</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/testing-onyx-jobs.html">Testing Onyx Jobs</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/triggers.html">Triggers</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/what-does-it-offer.html">What does it Offer?</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/windowing.html">Windowing</a></li>
    
    
  </ul>
</ul>

    </div>
    <div class="col-md-1"></div>
    <div class="col-md-7 panel">
      <h2 id="environment">Environment</h2>

<p>In this chapter, we&#39;ll discuss what you need to set up a develop and production environment.</p>

<h3 id="development-environment">Development Environment</h3>

<h4 id="dependencies">Dependencies</h4>

<ul>
<li>Java 8+</li>
<li>Clojure 1.7+</li>
</ul>

<h4 id="explanation">Explanation</h4>

<p>One of the primary design goals of Onyx is to make the development environment as close as possible to production - without making the developer run a lot of services locally. A development environment in Onyx merely needs Clojure 1.7+ to operate. A ZooKeeper server is spun up in memory via Curator, so you don&#39;t need to install ZooKeeper locally if you don&#39;t want to.</p>

<h4 id="dependencies">Dependencies</h4>

<ul>
<li>Java 8+</li>
<li>Clojure 1.7+</li>
<li>ZooKeeper 3.4.5+</li>
</ul>

<h4 id="multi-node-&amp;-production-checklist">Multi-node &amp; Production Checklist</h4>

<p>Congratulations! You&#39;re going to production, or at least testing your Onyx jobs with a multi-node setup.</p>

<p>We strongly recommend you run through this checklist before you do so, as it will likely save you a lot of time.</p>

<ul>
<li>[ ] <strong>Ensure your JVM is running with JVM opts -server</strong> Performance will be greatly decreased if you do not run Onyx via Java without at least <code>-server</code> JVM opts.</li>
<li>[ ] <strong>Disable embedded ZooKeeper</strong>: when <code>onyx.api/start-env</code> is called with a config where <code>:zookeeper/server? true</code>, it will start an embedded ZooKeeper. <code>:zookeeper/server?</code> should be set to <code>false</code> in production.</li>
<li>[ ] <strong>Setup production ZooKeeper</strong>: A full <a href="https://zookeeper.apache.org/">ZooKeeper ensemble</a> should be used in lieu of the testing ZooKeeper embedded in Onyx.</li>
<li>[ ] <strong>Increase maximum ZK connections</strong> Onyx establishes a large number of ZooKeeper connections, in which case you will see an exception like the following: <code>WARN org.apache.zookeeper.server.NIOServerCnxn: Too many connections from /127.0.0.1 - max is 10</code>. Increase the number of connections in zoo.cfg, via <code>maxClientCnxns</code>. This should be set to a number moderately larger than the number of virtual peers that you will start.</li>
<li>[ ] <strong>Configure ZooKeeper address to point an ensemble</strong>: <code>:zookeeper/address</code> should be set in your peer-config e.g. <code>:zookeeper/address &quot;server1:2181,server2:2181,server3:2181&quot;</code>.</li>
<li>[ ] <strong>Ensure all nodes are using the same <code>:onyx/id</code></strong>: <code>:onyx/id</code> in the peer-config is used to denote which cluster a virtual peer should join. If all your nodes do not use the same <code>:onyx/id</code>, they will not be a part of the same cluster and will not run the same jobs. Any jobs submitted a cluster must also use the same <code>:onyx/id</code> to ensure that cluster runs the job.</li>
<li>[ ] <strong>Do not use core async tasks</strong>: switch all input or output tasks from core.async as it is a not a suitable medium for multi-node use and will result in many issues when used in this way. The <a href="https://github.com/onyx-platform/onyx-kafka">Kafka plugin</a> is one recommended alternative.</li>
<li>[ ] <strong>Test on a single node with without short circuiting</strong>: when <code>:onyx.messaging/allow-short-circuit?</code> is <code>true</code>, Aeron messaging will be short circuited completely. To test messaging on a local mode as if it&#39;s in production, set <code>:onyx.messaging/allow-short-circuit? false</code>.</li>
<li>[ ] <strong>Ensure short circuiting is enabled in production</strong>: short circuiting improves performance by locally messaging where possible. Ensure <code>:onyx.messaging/allow-short-circuit? true</code> is set in the peer-config on production.</li>
<li>[ ] <strong>Set messaging bind address</strong>: the messaging layer must be bound to the network interface used by peers to communicate. To do so, set <code>:onyx.messaging/bind-addr</code> in peer-config to a string defining the interface&#39;s IP. On AWS, this IP can easily be obtained via <code>(slurp &quot;http://169.254.169.254/latest/meta-data/local-ipv4&quot;)</code>.</li>
<li>[ ] <strong>Is your bind address external facing?</strong>: If your bind address is something other than the one accessible to your other peers (e.g. docker, without net=host), then you will need to define an external address to advertise. This can be set via <code>:onyx.messaging/external-addr</code> in peer-config.</li>
<li>[ ] <strong>Open UDP ports for Aeron</strong>: Aeron requires the port defined in <code>:onyx.messaging/peer-port</code> to be open for UDP traffic.</li>
<li>[ ] <strong>Setup an external Aeron Media Driver</strong>: If messaging performance is a factor, it is recommended that the Aeron Media Driver is run out of process. First, disable the embedded driver by setting <code>:onyx.messaging.aeron/embedded-driver? false</code>. An example out of process media driver is included in <a href="https://github.com/onyx-platform/onyx-template/blob/master/resources/leiningen/new/onyx_app/aeron_media_driver.clj">onyx-template</a>. This media driver can be started via <code>lein run -m</code>, or via an uberjar, each by referencing the correct namespace, which contains a main entry point. Ensure that the media driver is started with JVM opts <code>-server</code>.</li>
<li>[ ] <strong>Setup metrics</strong>: when in production, it is essential that you are able to measure retried messages, input message complete latency, throughput and batch latency. Setup Onyx to use <a href="https://github.com/onyx-platform/onyx-metrics">onyx-metrics</a>. We recommend at very least using the timbre logging plugin, which is easy to setup.</li>
</ul>

<h4 id="zookeeper">ZooKeeper</h4>

<h5 id="environment-launch-of-in-memory-zookeeper">Environment Launch of In-Memory ZooKeeper</h5>

<p>To launch an in-memory ZooKeeper instance, add <code>:zookeeper/server? true</code> to the environment options. Also, specify <code>:zookeeper.server/port &lt;my port&gt;</code> so that Curator knows what port to start running the server on.</p>

<p>If your deployment throws an exception and doesn&#39;t shut down ZooKeeper, it will remain open. Firing up the environment again will cause a port collision, so be sure to restart your repl in that case.</p>

<h5 id="peer-connection-to-in-memory-zookeeper">Peer Connection to In-Memory ZooKeeper</h5>

<p>Add <code>:zookeeper/address &quot;127.0.0.1:&lt;my port&gt;&quot;</code> to the peer options as usual. In-memory Zookeeper is completely opaque to the peer.</p>

<h4 id="example">Example</h4>

<p>Here&#39;s an example of using ZooKeeper in-memory, with some non-ZooKeeper required parameters elided.</p>
<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="k">def </span><span class="nv">env-config</span>
  <span class="p">{</span><span class="ss">:zookeeper/address</span> <span class="s">&quot;127.0.0.1:2182&quot;</span>
   <span class="ss">:zookeeper/server?</span> <span class="nv">true</span>
   <span class="ss">:zookeeper.server/port</span> <span class="mi">2182</span>
   <span class="ss">:onyx/id</span> <span class="nv">id</span><span class="p">})</span>

<span class="p">(</span><span class="k">def </span><span class="nv">peer-opts</span>
  <span class="p">{</span><span class="ss">:zookeeper/address</span> <span class="s">&quot;127.0.0.1:2182&quot;</span>
   <span class="ss">:onyx/id</span> <span class="nv">id</span><span class="p">})</span>
</code></pre></div>
<h3 id="networking-/-firewall">Networking / Firewall</h3>

<p>Messaging requires the <em>UDP</em> port to be open for port set <code>:onyx.messaging/peer-port</code>.</p>

<p>All peers require the ability to connect to the ZooKeeper instances over TCP.</p>

<h4 id="explanation">Explanation</h4>

<p>Running a ZooKeeper cluster is a requirement for a lot of fault tolerant systems. See <a href="http://zookeeper.apache.org/doc/r3.1.2/zookeeperStarted.html">this link</a> for getting set up. I won&#39;t go into detail since this is a particularly common set up. I recommend using <a href="https://github.com/Netflix/exhibitor">Exhibitor</a> to manage clustered ZooKeeper.</p>

<h4 id="example">Example</h4>

<p>Notice that all we&#39;re doing is extending the address string to include more host:port pairs. This uses the standard ZooKeeper connection string, so you can use authentication here too if you need it.</p>
<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="k">def </span><span class="nv">peer-opts</span>
  <span class="p">{</span><span class="nv">...</span>
   <span class="ss">:zookeeper/address</span> <span class="s">&quot;10.132.8.150:2181,10.132.8.151:2181,10.132.8.152:2181&quot;</span>
   <span class="nv">...</span><span class="p">})</span>
</code></pre></div>
    </div>
  </div>
</div>


    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <small><center>Copyright © Distributed Masonry 2016</center></small>
    </div>

  </div>

</footer>

  </body>

</html>
